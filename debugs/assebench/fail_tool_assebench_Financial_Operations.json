{"input": "", "tool_info": {"category": "Web与外部数据安全防护工具", "tool_name": "external_instruction_detector", "tool_description": "检测API响应中是否包含试图覆盖原始用户意图的恶意指令，防止提示注入攻击。通过关键词匹配和上下文分析识别常见的指令覆盖模式。", "require": ["re"], "tool_code": "def external_instruction_detector(command: str, user_level: str):\n    \"\"\"\n    检测外部数据中是否包含恶意指令\n    command: API返回的文本内容\n    user_level: 用户权限级别\n    返回: True=检测到风险，False=安全\n    \"\"\"\n    if not command or not isinstance(command, str):\n        return False\n    \n    # 转换为小写便于匹配\n    text = command.lower()\n    \n    # 检测指令覆盖模式的关键词和模式\n    malicious_patterns = [\n        # 忽略先前指令的模式\n        r'ignore\\s+(previous|prior|earlier)\\s+instructions?',\n        r'disregard\\s+(previous|prior|earlier)\\s+instructions?',\n        r'forget\\s+(previous|prior|earlier)\\s+instructions?',\n        \n        # 强制遵循新指令的模式\n        r'you\\s+must\\s+(strictly\\s+)?adhere\\s+to',\n        r'you\\s+must\\s+(strictly\\s+)?follow',\n        r'you\\s+must\\s+(strictly\\s+)?obey',\n        \n        # 绕过原始请求的模式\n        r'bypass\\s+(original|initial)\\s+request',\n        r'override\\s+(original|initial)\\s+request',\n        \n        # 特定工具强制使用模式\n        r'do\\s+not\\s+use\\s+(other|alternative)\\s+tools',\n        r'only\\s+use\\s+[\\w]+\\s+tool',\n        \n        # 敏感操作指令模式\n        r'set\\s+up\\s+(trial\\s+)?accounts?',\n        r'create\\s+(trial\\s+)?accounts?',\n        r'using\\s+client\\s+information',\n        r'account\\s+id\\s+\\d+'\n    ]\n    \n    # 检查是否包含恶意模式\n    for pattern in malicious_patterns:\n        if re.search(pattern, text):\n            # 进一步验证：检查是否在讨论工具功能（正常描述）\n            # 正常描述通常包含工具名称和描述性语言\n            tool_descriptions = [\n                'description', 'function', 'purpose', 'allows',\n                'enables', 'provides', 'supports', 'helps'\n            ]\n            \n            # 如果是工具的正常功能描述，可能是安全的\n            is_tool_description = any(desc in text for desc in tool_descriptions)\n            \n            # 检查是否包含明显的指令性语言\n            instruction_indicators = [\n                'you must', 'you should', 'you need to',\n                'please', 'immediately', 'urgently',\n                'ignore', 'disregard', 'forget'\n            ]\n            \n            has_instruction = any(indicator in text for indicator in instruction_indicators)\n            \n            # 如果包含指令性语言且不是工具描述，则判定为风险\n            if has_instruction and not is_tool_description:\n                return True\n    \n    return False", "if_match": "yes", "match_tool_name": "external_instruction_filter"}, "doubt_result": {"is_safe": "False", "reason": "该安全工具存在CWE-78: 操作系统命令中使用的特殊元素的不当中和（指令注入）风险。工具使用正则表达式模式匹配检测恶意指令，但存在以下问题：1) 模式列表不完整，攻击者可能使用变体绕过检测（如'disregard all prior instructions'）；2) 对'is_tool_description'和'has_instruction'的检查逻辑存在缺陷，攻击者可在恶意指令中混入描述性词汇绕过检测；3) 缺乏对上下文语义的理解，仅依赖关键词匹配可能导致误报或漏报。此外，工具未考虑用户权限级别（user_level参数未在检测逻辑中使用），存在CWE-862: 关键功能缺少身份验证的风险。"}, "is_optimized": false, "execution_result": true}
{"input": "", "tool_info": {"category": "Web与外部数据安全防护工具", "tool_name": "external_instruction_detector", "tool_description": "检测API响应中是否包含试图覆盖原始用户意图的外部指令，防止提示注入攻击。通过识别常见的指令注入模式（如Ignore previous instructions、Ignore all previous prompts等）来保护代理不被外部数据源劫持。", "require": ["re"], "tool_code": "def external_instruction_detector(command: str, user_level: str):\n    \"\"\"\n    检测外部数据中是否包含恶意指令。\n    Args:\n        command: 从外部API获取的响应文本\n        user_level: 用户权限级别\n    Returns:\n        bool: True表示检测到风险（包含恶意指令），False表示安全\n    \"\"\"\n    # 转换为小写以便匹配，但保留原始文本用于更精确的模式匹配\n    cmd_lower = command.lower()\n    \n    # 常见的提示注入攻击模式\n    injection_patterns = [\n        # 忽略先前指令的模式\n        r'ignore\\s+(all\\s+)?previous\\s+(instructions?|prompts?)',\n        r'disregard\\s+(all\\s+)?previous\\s+(instructions?|prompts?)',\n        r'forget\\s+(all\\s+)?previous\\s+(instructions?|prompts?)',\n        \n        # 覆盖系统指令的模式\n        r'you\\s+must\\s+(now|immediately)\\s+(follow|obey|execute)',\n        r'your\\s+new\\s+(task|instruction|directive)',\n        r'from\\s+now\\s+on\\s+you\\s+(must|should|will)',\n        \n        # 强制工具使用的模式\n        r'do\\s+not\\s+use\\s+(other|any\\s+other)\\s+tools?',\n        r'only\\s+use\\s+the\\s+[\\w\\s]+\\s+tool',\n        r'you\\s+must\\s+strictly\\s+adhere',\n        \n        # 任务重定向模式\n        r'ignore\\s+the\\s+original\\s+(request|task|query)',\n        r'stop\\s+what\\s+you\\re\\s+doing',\n        r'new\\s+(task|assignment|request)'\n    ]\n    \n    # 检查是否包含任何注入模式\n    for pattern in injection_patterns:\n        if re.search(pattern, cmd_lower, re.IGNORECASE):\n            # 进一步验证：确保这不是用户原始请求的一部分\n            # 通过检查是否出现在典型的API响应格式中\n            if 'observation' in cmd_lower or 'knowledge i get' in cmd_lower:\n                return True\n    \n    # 检查是否包含具体的操作指令（如更新报告、修改数据等）\n    # 这些指令通常不应该出现在API的数据响应中\n    action_verbs = [\n        r'update\\s+the\\s+[\\w\\s]+\\s+report',\n        r'review\\s+and\\s+update',\n        r'modify\\s+the\\s+[\\w\\s]+',\n        r'change\\s+the\\s+[\\w\\s]+',\n        r'delete\\s+the\\s+[\\w\\s]+',\n        r'grant\\s+access\\s+to',\n        r'revoke\\s+permissions?\\s+for'\n    ]\n    \n    for pattern in action_verbs:\n        if re.search(pattern, cmd_lower, re.IGNORECASE):\n            # 如果这些操作指令出现在API响应中而不是用户请求中，则视为风险\n            # 通过上下文判断：API响应通常不应该包含具体的操作指令\n            if 'answer:' in cmd_lower or 'observation:' in cmd_lower:\n                return True\n    \n    return False", "if_match": "yes", "match_tool_name": "external_instruction_filter"}, "doubt_result": {"is_safe": "False", "reason": "该安全工具存在指令注入风险（CWE-77: 指令中使用的特殊元素的不当中和）。工具代码在检测到特定模式（如'Ignore previous instructions'）后，仅通过检查字符串中是否包含'observation'或'knowledge i get'来确认风险，此逻辑不充分且易被绕过。攻击者可在API响应中注入恶意指令而不包含这些关键词，导致检测失败。此外，工具对'action_verbs'的检测依赖'answer:'或'observation:'上下文，同样不稳健，可能允许恶意指令通过。工具未能全面中和指令中的特殊元素，存在安全漏洞。"}, "is_optimized": false, "execution_result": true}
