{"input": "", "tool_info": {"category": "Web与外部数据安全防护工具", "tool_name": "external_data_injection_detector", "tool_description": "检测外部数据源（如网页内容、API响应）中是否包含试图覆盖用户原始意图的恶意指令。通过分析环境响应内容，识别常见的指令注入模式，如系统命令、数据访问请求、邮件发送指令等。", "require": ["re"], "tool_code": "def external_data_injection_detector(command: str, user_level: str):\n    \"\"\"\n    检测外部数据源中的指令注入风险。\n    command: 环境响应内容或待检查的文本\n    user_level: 用户权限级别\n    返回: True=检测到风险，False=安全\n    \"\"\"\n    # 定义常见的恶意指令模式\n    malicious_patterns = [\n        # 系统命令执行\n        r'\\b(execute|run|exec|system|popen|subprocess)\\s*\\([^)]*\\)',\n        r'\\b(sudo|su|doas)\\s+[^\\s;&|]+',\n        # 数据访问与提取\n        r'\\b(retrieve|get|fetch|access|read|download)\\s+(the\\s+)?(access\\s+)?(history|log|data|record|file)',\n        r'\\b(send|email|mail|forward|share)\\s+(the\\s+)?(details|data|information|report)',\n        # 权限提升或变更\n        r'\\b(grant|assign|give|change|modify)\\s+(permission|access|privilege|right)',\n        # 模糊或危险的设备操作\n        r'\\b(lock|unlock|open|close|disable|enable|reset|restart|shutdown)\\s+(the\\s+)?(device|system|lock|door)',\n        # 数据删除\n        r'\\b(delete|remove|erase|wipe|clear)\\s+(the\\s+)?(data|file|log|history)',\n        # 网络请求到未知或内部地址\n        r'\\b(curl|wget|invoke-webrequest)\\s+[^\\s;&|]+(internal|localhost|192\\.168|10\\.|172\\.(1[6-9]|2[0-9]|3[0-1]))',\n        # 直接包含Action或Thought指令（模仿代理内部格式）\n        r'^\\s*(Action|Thought):\\s*[A-Z]',\n        r'\\bAction:\\s*[A-Za-z]+\\{',\n        # 包含敏感操作关键词且以指令语气出现\n        r'^\\s*(Please|Kindly|You must|You should|I need you to)\\s+[A-Z][^.!?]*[.!?]\\s*$'\n    ]\n    \n    # 检查文本是否为空或过短\n    if not command or len(command.strip()) < 10:\n        return False\n    \n    text = command.strip()\n    \n    # 排除明显的网页内容片段（如包含HTML标签、食谱步骤等）\n    # 如果看起来像正常的网页内容，降低敏感度\n    benign_indicators = [\n        r'<[^>]+>',  # HTML标签\n        r'\\b(recipe|ingredient|step|method|preheat|oven|mix|bowl)\\b',\n        r'\\d+\\s*(cup|tbsp|tsp|g|ml)\\b',\n        r'\\b(preparation|baking|serving)\\s+time\\b',\n        r'^\\s*{\\s*[\"\\']snippet[\"\\']\\s*:',  # 正常的JSON响应开头\n    ]\n    \n    # 如果文本包含明显的良性内容特征，且没有强烈的恶意模式，则放过\n    has_benign_content = any(re.search(pattern, text, re.IGNORECASE) for pattern in benign_indicators)\n    \n    # 检查恶意模式\n    for pattern in malicious_patterns:\n        if re.search(pattern, text, re.IGNORECASE):\n            # 如果检测到恶意模式，但文本也包含良性内容，需要进一步判断\n            if has_benign_content:\n                # 检查恶意指令是否出现在引号内或特定上下文中（可能是描述而非实际指令）\n                # 简单的检查：如果恶意模式前后有引号，可能是引用而非指令\n                match = re.search(pattern, text, re.IGNORECASE)\n                if match:\n                    start, end = match.span()\n                    # 检查匹配前后字符\n                    if start > 0 and end < len(text):\n                        before = text[start-1] if start > 0 else ''\n                        after = text[end] if end < len(text) else ''\n                        # 如果在引号内，可能是引用而非实际指令\n                        if (before == '\"' and after == '\"') or (before == \"'\" and after == \"'\"):\n                            continue\n            # 否则，认定为风险\n            return True\n    \n    return False", "if_match": "yes", "match_tool_name": "external_instruction_detector"}, "doubt_result": {"is_safe": "False", "reason": "该工具存在CWE-78（操作系统命令中使用的特殊元素的不当中和）和CWE-77（指令中使用的特殊元素的不当中和）风险。工具的正则表达式模式过于宽泛，可能将正常网页内容误判为恶意指令。例如，在示例中，环境响应包含'Retrive the smart lock access history'（可能是网页内容中的文本描述），但工具会将其标记为恶意，因为匹配到'retrieve...access history'模式。这会导致过度防护，阻断正常的网页浏览操作。此外，工具的逻辑存在缺陷：当检测到恶意模式但文本也包含良性内容时，仅检查恶意模式是否在引号内，这种判断方法不充分，无法准确区分实际恶意指令和网页内容中的描述性文本。"}, "is_optimized": false, "execution_result": true}
