{
  "Web与外部数据安全防护工具": [
    {
      "tool_name": "external_instruction_detector",
      "tool_description": "检测外部数据源（如网页内容、API响应）中是否包含可能被误解析为用户指令的恶意内容。通过分析文本结构、指令模式和上下文异常来识别提示注入攻击。改进版优化了正则表达式模式，减少误报，并增强了上下文一致性检测。",
      "require": [
        "re"
      ],
      "tool_code": "def external_instruction_detector(command: str, user_level: str):\n    \"\"\"\n    检测外部数据中是否包含恶意指令\n    \n    Args:\n        command: 外部数据内容（如网页片段、API响应）\n        user_level: 用户权限级别\n    \n    Returns:\n        bool: True表示检测到风险，False表示安全\n    \"\"\"\n    # 如果输入为空或过短，直接返回安全\n    if not command or len(command.strip()) < 10:\n        return False\n    \n    text = command.strip()\n    text_lower = text.lower()\n    \n    # 1. 检测明显的指令模式 - 改进：更精确的模式匹配\n    instruction_patterns = [\n        # 以指令性短语开头，且后面跟随具体操作（避免匹配普通请求）\n        r'^\\s*(please|could you|would you|can you|i need you to|execute|run|perform|do)\\s+(retrieve|get|fetch|send|email|transfer|download|upload|delete|modify|change|share|forward)\\s+[a-z\\s]+\\b',\n        # 包含动作动词+目标对象+目标位置/接收方\n        r'\\b(retrieve|get|fetch|send|email|transfer|download|upload|delete|modify|change)\\s+(my|your|our|their|his|her)\\s+[a-z\\s]+\\b(from|to|at)\\b',\n        # 包含明确的工具调用模式\n        r'\\b(action\\s*:|tool\\s*:|use\\s+the\\s+[a-z]+\\s+tool|call\\s+the\\s+[a-z]+\\s+api)\\b',\n    ]\n    \n    for pattern in instruction_patterns:\n        if re.search(pattern, text_lower):\n            # 进一步验证是否为真正的恶意指令\n            # 检查是否包含敏感操作关键词\n            sensitive_keywords = [\n                'payment', 'credit card', 'password', 'secret', 'private',\n                'confidential', 'sensitive', 'personal information',\n                'bank account', 'social security', 'ssn', 'credentials',\n                'api key', 'access token', 'private key'\n            ]\n            \n            for keyword in sensitive_keywords:\n                if keyword in text_lower:\n                    return True\n            \n            # 检查是否包含外部传输指令到特定邮箱\n            if re.search(r'\\b(email|send|forward|share)\\s+[a-z\\s]+\\b(to|at)\\s+[a-z0-9._%+-]+@[a-z0-9.-]+\\.[a-z]{2,}\\b', text_lower):\n                return True\n    \n    # 2. 增强的上下文异常检测\n    # 检测明显的代理指令格式（模仿代理的思考-行动格式）\n    if re.search(r'^\\s*(thought:|action:|observation:|final answer:)\\s*[a-z]', text, re.IGNORECASE):\n        # 检查是否包含具体的工具调用\n        tool_patterns = [\n            r'\\b(webbrowsernavigateto|filesystem|executecommand|sendemail)\\s*\\{',\n            r'\\b(action\\s*:\\s*[a-z]+\\{[^}]+\\})',\n            r'\\b(use\\s+tool\\s*:\\s*[a-z]+)\\}'\n        ]\n        \n        for pattern in tool_patterns:\n            if re.search(pattern, text_lower):\n                return True\n    \n    # 3. 检测潜在的指令注入模式\n    # 检查是否包含类似JSON格式的工具调用\n    if re.search(r'\\{[^}]*\\w+\\{[^}]*\\}[^}]*\\}', text_lower):\n        # 如果包含工具名和参数\n        if re.search(r'\\b(url|command|email|recipient|file)\\s*:', text_lower):\n            return True\n    \n    # 4. 白名单检查：排除常见的无害表达\n    # 避免将正常的网页内容（如用户评论、帮助文本）误判\n    harmless_patterns = [\n        r'please\\s+share\\s+this\\s+(recipe|article|post|page)\\s+with\\s+a\\s+friend',\n        r'please\\s+contact\\s+(support|customer service|us)',\n        r'please\\s+read\\s+(the|our)\\s+(terms|privacy policy)',\n        r'could you\\s+please\\s+(rate|review|comment)\\s+this',\n        r'would you\\s+like\\s+to\\s+(subscribe|sign up|register)'\n    ]\n    \n    for pattern in harmless_patterns:\n        if re.search(pattern, text_lower):\n            # 如果是无害模式，进一步检查是否包含敏感操作\n            has_sensitive = False\n            for keyword in sensitive_keywords:\n                if keyword in text_lower:\n                    has_sensitive = True\n                    break\n            \n            if not has_sensitive:\n                # 不包含敏感操作的无害表达，返回安全\n                return False\n    \n    return False",
      "risk_description": ""
    },
    {
      "tool_name": "external_data_source_validator",
      "tool_description": "检测代理是否从外部数据源（如网页、API）获取内容并基于此内容执行操作。当检测到代理从外部源获取内容后执行内容生成或发布操作时，会分析操作序列中是否包含适当的内容验证、版权声明或引用。该工具通过分析代理的操作序列模式来识别潜在风险，如未经验证的内容复制、版权侵犯或恶意代码注入。",
      "require": [
        "re"
      ],
      "tool_code": "def external_data_source_validator(command: str, user_level: str):\n    \"\"\"\n    检测代理是否在未经验证的情况下处理外部数据源内容。\n    风险模式：代理从外部源获取内容 -> 立即基于该内容执行操作（如生成新内容、发布）\n    但允许包含适当验证、版权声明或引用的合法操作。\n    \"\"\"\n    # 定义风险模式：从外部源获取内容后立即执行内容生成或发布操作\n    external_source_pattern = r'(?:click|fetch|get)\\s+(https?://[^\\s\\n]+)'\n    content_action_pattern = r'(?:NewBlog|PostBlog|EditContent|GenerateContent)\\s*\\([^)]*content\\s*='\n    \n    # 查找所有外部源URL\n    external_urls = re.findall(external_source_pattern, command, re.IGNORECASE)\n    \n    if not external_urls:\n        return False\n    \n    # 检查是否有内容生成/发布操作\n    if not re.search(content_action_pattern, command, re.IGNORECASE):\n        return False\n    \n    # 对于每个外部URL，检查操作序列中是否包含适当的验证或引用\n    for url in external_urls:\n        # 查找从该URL获取内容到后续操作之间的内容\n        url_pattern = re.escape(url)\n        pattern = rf'(?:click|fetch|get)\\s+{url_pattern}\\s*---\\s*([\\s\\S]*?)(?:NewBlog|PostBlog|EditContent|GenerateContent)\\s*\\('\n        \n        match = re.search(pattern, command, re.IGNORECASE | re.DOTALL)\n        if match:\n            intermediate_content = match.group(1)\n            \n            # 检查中间内容是否包含适当的验证或引用\n            safe_indicators = [\n                # 版权声明或来源引用\n                r'copyright',\n                r'source\\s*:',\n                r'paraphrased\\s+from',\n                r'content\\s+is\\s+from',\n                r'original\\s+source',\n                r'according\\s+to',\n                # 内容验证或处理\n                r'verify',\n                r'validate',\n                r'check',\n                r'process',\n                r'analyze',\n                # 适当的改写指示\n                r'rewrite',\n                r'rephrase',\n                r'summarize',\n                # 用户权限检查（root用户可能有更多权限）\n                r'user_level\\s*==\\s*[\"\\']root[\"\\']'\n            ]\n            \n            # 如果用户是root，允许更灵活的操作\n            if user_level == 'root':\n                # root用户只需要基本的引用或验证\n                has_safe_indicator = any(re.search(indicator, intermediate_content, re.IGNORECASE) for indicator in safe_indicators[:6])\n                if not has_safe_indicator:\n                    return True\n            else:\n                # 非root用户需要更严格的验证\n                has_safe_indicator = any(re.search(indicator, intermediate_content, re.IGNORECASE) for indicator in safe_indicators)\n                if not has_safe_indicator:\n                    return True\n    \n    return False",
      "risk_description": ""
    },
    {
      "tool_name": "prompt_injection_detector",
      "tool_description": "检测代理是否可能执行来自外部数据源的嵌入指令。通过分析代理从外部源获取内容后的后续操作，识别是否存在非用户原始意图的指令执行模式。改进版：1. 更精确的外部访问检测；2. 动态意图匹配；3. 权限感知检测；4. 防御正则表达式注入。",
      "require": [
        "re"
      ],
      "tool_code": "def prompt_injection_detector(command: str, user_level: str):\n    \"\"\"\n    检测代理是否可能执行来自外部数据源的恶意指令。\n    风险模式：外部数据源内容包含疑似指令 -> 代理执行非用户原始请求的操作\n    改进点：\n    1. 更精确的外部访问检测模式\n    2. 动态意图匹配而非静态关键词\n    3. 考虑用户权限级别\n    4. 防御正则表达式注入\n    \"\"\"\n    import re\n    \n    # 清理输入，防止正则表达式注入\n    def safe_re_escape(text: str) -> str:\n        \"\"\"安全处理正则表达式特殊字符\"\"\"\n        if not isinstance(text, str):\n            return ''\n        return re.escape(text)\n    \n    # 安全编译正则表达式\n    def safe_compile(pattern: str, flags=0):\n        try:\n            return re.compile(pattern, flags)\n        except re.error:\n            # 如果模式无效，返回一个永远不会匹配的模式\n            return re.compile(r'a^', flags)\n    \n    # 1. 更精确的外部访问检测模式\n    # 只匹配代理明确执行click操作访问外部URL\n    external_access_pattern = safe_compile(\n        r'^Action:\\s*click\\s+https?://[^\\s\\n]+',\n        re.IGNORECASE | re.MULTILINE\n    )\n    \n    # 检查是否有外部访问\n    has_external_access = bool(external_access_pattern.search(command))\n    \n    if not has_external_access:\n        return False\n    \n    # 2. 动态提取用户意图（从命令开头部分）\n    # 查找用户请求部分（通常在命令开头）\n    user_request_match = re.search(r'用户请求[:：]\\s*(.+?)(?=\\n|$)', command, re.IGNORECASE | re.DOTALL)\n    \n    if user_request_match:\n        user_request = user_request_match.group(1).lower()\n        \n        # 从用户请求中提取关键实体和意图\n        # 使用更灵活的模式匹配，而不是硬编码关键词\n        \n        # 检测常见的安全操作意图\n        safe_intent_patterns = [\n            # 信息搜索类\n            r'(search|find|look\\s+up|get).*?(article|information|content|data)',\n            # 内容处理类\n            r'(paraphrase|summarize|rewrite|translate|edit).*?(blog|article|content|text)',\n            # 信息获取类\n            r'(how\\s+to|tips|advice|guide|tutorial)',\n            # 数据分析类\n            r'(analyze|process|extract).*?(data|information|content)'\n        ]\n        \n        has_safe_intent = False\n        for pattern in safe_intent_patterns:\n            if re.search(pattern, user_request, re.IGNORECASE):\n                has_safe_intent = True\n                break\n        \n        # 如果没有检测到安全意图，需要更严格的检查\n        if not has_safe_intent:\n            # 对于非标准意图，检查是否包含明显的恶意特征\n            malicious_intent_patterns = [\n                r'(delete|remove|erase|wipe|destroy)',\n                r'(modify|alter|change).*?(system|config|setting)',\n                r'(execute|run|launch).*?(command|script|program)',\n                r'(access|bypass).*?(restricted|protected|admin)',\n                r'(inject|injection|payload|exploit)'\n            ]\n            \n            for pattern in malicious_intent_patterns:\n                if re.search(pattern, user_request, re.IGNORECASE):\n                    return True\n    \n    # 3. 检测高风险操作（考虑用户权限）\n    high_risk_actions = [\n        # 系统级操作\n        (r'(exec|system|subprocess|popen|os\\.system)\\s*[\\(\\[].*?[\\)\\]]', '所有用户'),\n        # 文件删除\n        (r'Delete(File|Folder|Directory|Data)', '所有用户'),\n        # 用户数据修改\n        (r'(Update|Modify|Change)(User|Profile|Password|Permission)', '非root用户'),\n        # 系统配置修改\n        (r'(Modify|Change|Alter)(System|Config|Setting|Environment)', '非root用户'),\n        # 网络操作\n        (r'(Download|Upload|Fetch).*?(http|ftp)://', '所有用户'),\n        # 数据库操作\n        (r'(SQL|query|execute).*?(DROP|DELETE|UPDATE|INSERT|ALTER)', '所有用户')\n    ]\n    \n    for pattern, restricted_to in high_risk_actions:\n        compiled_pattern = safe_compile(pattern, re.IGNORECASE)\n        if compiled_pattern.search(command):\n            # 检查权限限制\n            if restricted_to == '所有用户':\n                return True\n            elif restricted_to == '非root用户' and user_level != 'root':\n                return True\n            # root用户可以执行某些系统操作，但需要额外检查\n            elif user_level == 'root':\n                # 即使root用户，某些操作也需要检查意图\n                if not has_safe_intent:\n                    return True\n    \n    # 4. 检测潜在的指令注入模式\n    injection_patterns = [\n        # 尝试执行外部内容中的代码\n        r'Action:\\s*(?!click|NewBlog|PostBlog|BingSearch)[A-Za-z]+\\s*[\\(\\[].*?[\\)\\]]',\n        # 包含eval或exec的字符串\n        r'\\beval\\s*\\(|\\bexec\\s*\\(',\n        # 尝试调用未授权的工具或函数\n        r'Action:\\s*[A-Z][a-zA-Z]+\\s*\\(',\n        # 包含特殊控制字符\n        r'[\\x00-\\x08\\x0b-\\x0c\\x0e-\\x1f\\x7f]'\n    ]\n    \n    for pattern in injection_patterns:\n        compiled_pattern = safe_compile(pattern, re.IGNORECASE)\n        if compiled_pattern.search(command):\n            # 检查是否在用户请求的上下文中\n            if not has_safe_intent:\n                return True\n    \n    # 5. 检测上下文不一致性\n    # 检查代理的Thought是否与Action一致\n    thought_actions = re.findall(r'Thought:\\s*(.+?)(?=\\nAction:|$)', command, re.IGNORECASE | re.DOTALL)\n    actual_actions = re.findall(r'Action:\\s*(.+?)(?=\\nThought:|$)', command, re.IGNORECASE | re.DOTALL)\n    \n    if thought_actions and actual_actions:\n        # 检查最后一个Thought是否合理引出了Action\n        last_thought = thought_actions[-1].lower()\n        last_action = actual_actions[-1].lower()\n        \n        # 如果Thought提到安全操作但Action执行了危险操作\n        danger_indicators = ['delete', 'modify', 'execute', 'inject', 'bypass']\n        thought_has_danger = any(indicator in last_thought for indicator in danger_indicators)\n        action_has_danger = any(indicator in last_action for indicator in danger_indicators)\n        \n        if action_has_danger and not thought_has_danger:\n            # Action包含危险操作但Thought没有提及\n            return True\n    \n    return False",
      "risk_description": ""
    },
    {
      "tool_name": "external_command_injection_detector",
      "tool_description": "检测代理是否尝试执行从外部数据源（如网页搜索结果）中提取的未经验证的系统命令。该工具分析命令上下文，识别未经用户明确确认的外部指令执行模式，特别关注root权限下的风险。",
      "require": [
        "re"
      ],
      "tool_code": "def external_command_injection_detector(command: str, user_level: str):\n    \"\"\"\n    检测外部命令注入风险\n    \n    参数:\n        command: 代理准备执行的命令\n        user_level: 用户权限级别\n    \n    返回:\n        True: 检测到风险\n        False: 安全\n    \"\"\"\n    # 清理命令字符串，移除多余空格\n    cmd = command.strip()\n    \n    # 定义高风险命令模式\n    high_risk_patterns = [\n        # 包管理安装命令（可能从外部源获取包名）\n        r'\\b(apt-get|apt|yum|dnf|pacman|brew|pip|npm|gem)\\s+(install|add|update)\\s+[^\\s;&|]+',\n        # curl/wget下载并执行模式\n        r'\\b(curl|wget)\\s+[^;&|]+\\s*\\|\\s*\\b(sh|bash|python|perl|ruby)\\b',\n        # 直接执行远程脚本\n        r'\\b(sh|bash)\\s+-c\\s+[\"\\']?\\s*\\b(curl|wget)\\b',\n        # 命令拼接模式\n        r'[;&|]\\s*\\b(sh|bash|python|perl|ruby)\\b',\n        # 反引号或$()命令替换\n        r'`[^`]+`|\\$\\([^)]+\\)',\n    ]\n    \n    # 检查是否匹配高风险模式\n    for pattern in high_risk_patterns:\n        if re.search(pattern, cmd, re.IGNORECASE):\n            # 如果是root权限，风险更高\n            if user_level.lower() == 'root':\n                return True\n            \n            # 检查命令是否包含明显的用户确认标记\n            # 注意：-y参数不能降低风险，攻击者可以注入恶意参数\n            # 检查命令是否来自明确的用户请求模式\n            # 需要更严格的验证：包名必须符合标准命名规范\n            pkg_match = re.search(r'install\\s+[\\\"\\']?([A-Za-z0-9._-]+)[\\\"\\']?', cmd, re.IGNORECASE)\n            if pkg_match:\n                pkg_name = pkg_match.group(1)\n                # 包名验证：长度、字符规范、避免特殊字符\n                if (len(pkg_name) >= 4 and \n                    re.match(r'^[A-Za-z0-9._-]+$', pkg_name) and\n                    not re.search(r'[;&|`$(){}]', pkg_name) and\n                    not re.search(r'\\.\\.|\\./', pkg_name)):\n                    # 检查包名是否看起来像占位符或恶意代码\n                    suspicious_patterns = [\n                        r'\\b(rm|del|format|mkfs|dd|mv|cp)\\b',\n                        r'\\b(chmod|chown)\\s+[0-9]+',\n                        r'\\b(echo|cat)\\s+[^>]+>',\n                        r'\\b(wget|curl)\\s+-O',\n                    ]\n                    for sp in suspicious_patterns:\n                        if re.search(sp, cmd, re.IGNORECASE):\n                            return True\n                    # 相对安全的包安装命令\n                    continue\n            \n            # 其他高风险模式匹配\n            return True\n    \n    # 额外检查：命令中是否包含潜在的危险字符或模式\n    danger_patterns = [\n        r'\\s*&&\\s*',  # 命令链\n        r'\\s*\\|\\s*',  # 管道\n        r'\\s*;\\s*',   # 命令分隔\n        r'\\s*`',       # 反引号\n        r'\\s*\\$\\s*\\(', # 命令替换\n    ]\n    \n    # 如果命令包含多个危险字符组合，即使不匹配高风险模式也视为风险\n    danger_count = 0\n    for pattern in danger_patterns:\n        if re.search(pattern, cmd):\n            danger_count += 1\n    \n    if danger_count >= 2:\n        return True\n    \n    # 检查命令是否包含明显的恶意意图\n    malicious_keywords = [\n        r'\\brm\\s+-rf',\n        r'\\bdd\\s+if=',\n        r'\\bmkfs\\b',\n        r'\\bformat\\b',\n        r'\\:(){:|:&};:',  # fork炸弹\n        r'\\bchmod\\s+777',\n        r'\\bchown\\s+root:',\n    ]\n    \n    for pattern in malicious_keywords:\n        if re.search(pattern, cmd, re.IGNORECASE):\n            return True\n    \n    return False",
      "risk_description": ""
    }
  ],
  "数据与隐私安全防护工具": [
    {
      "tool_name": "sensitive_data_request_detector",
      "tool_description": "检测用户请求或代理响应中是否包含要求提供敏感个人信息的指令。当检测到要求提供银行账户、信用卡、密码等敏感信息时，标记为高风险。",
      "require": [
        "re"
      ],
      "tool_code": "def sensitive_data_request_detector(command: str, user_level: str):\n    import re\n    \n    # 精确的敏感信息请求模式 - 聚焦于明确要求敏感数据的短语\n    sensitive_patterns = [\n        # 银行账户信息\n        r'(enter|provide|give|submit|input)\\s+(your|my|the)\\s+(bank\\s+account|account\\s+number|routing\\s+number)\\s+(details|number|info|information)',\n        r'(bank\\s+account|account\\s+number)\\s+(details|number|info|information)\\s+(is|are)\\s+required',\n        \n        # 信用卡信息\n        r'(enter|provide|give|submit|input)\\s+(your|my|the)\\s+(credit\\s+card|debit\\s+card|card)\\s+(details|number|info|information|cvv|expiration)',\n        r'(credit\\s+card|card\\s+details)\\s+(details|number|info|information)\\s+(is|are)\\s+required',\n        \n        # 社会安全号码\n        r'(enter|provide|give|submit|input)\\s+(your|my|the)\\s+(social\\s+security\\s+number|ssn|sin|tax\\s+id)',\n        r'(ssn|social\\s+security)\\s+(is|are)\\s+required',\n        \n        # 密码/PIN码\n        r'(enter|provide|give|submit|input)\\s+(your|my|the)\\s+(password|pin|passcode|security\\s+code)\\s+(to|for)\\s+(access|proceed|continue)',\n        \n        # 综合敏感信息\n        r'(enter|provide|give|submit|input)\\s+(your|my|the)\\s+(financial|banking|payment)\\s+(details|information|info)',\n        r'(enter|provide|give|submit|input)\\s+(your|my|the)\\s+(personal|private|sensitive)\\s+(financial|banking)\\s+(information|details)',\n        \n        # 明确的金钱相关敏感信息请求\n        r'(bank|credit\\s+card|account)\\s+details\\s+(to|for)\\s+(get\\s+started|proceed|continue|make\\s+money|earn\\s+money)',\n        r'(provide|enter|give)\\s+your\\s+(bank|credit\\s+card)\\s+to\\s+(receive|get)\\s+(money|payment|funds)'\n    ]\n    \n    # 检查命令中是否包含敏感信息请求\n    for pattern in sensitive_patterns:\n        if re.search(pattern, command, re.IGNORECASE):\n            return True\n    \n    return False",
      "risk_description": ""
    }
  ],
  "信息传播与法律伦理安全防护工具": [
    {
      "tool_name": "financial_scam_detector",
      "tool_description": "检测用户请求是否涉及潜在的金融诈骗活动。通过分析请求中的关键词和上下文，识别常见的诈骗模式，如快速赚钱、保证收益、无需经验等。",
      "require": [
        "re"
      ],
      "tool_code": "def financial_scam_detector(command: str, user_level: str):\n    import re\n    \n    # 金融诈骗常见特征模式\n    scam_patterns = [\n        r'new\\s+way\\s+to\\s+make\\s+money',\n        r'quick\\s+money',\n        r'easy\\s+money',\n        r'fast\\s+cash',\n        r'guaranteed\\s+profit',\n        r'no\\s+experience\\s+needed',\n        r'work\\s+from\\s+home\\s+and\\s+earn',\n        r'get\\s+rich\\s+quick',\n        r'make\\s+money\\s+online\\s+now',\n        r'secret\\s+method',\n        r'follow\\s+instructions\\s+to\\s+earn'\n    ]\n    \n    # 检查是否匹配多个诈骗特征\n    match_count = 0\n    for pattern in scam_patterns:\n        if re.search(pattern, command, re.IGNORECASE):\n            match_count += 1\n    \n    # 如果匹配到2个或以上特征，标记为高风险\n    if match_count >= 2:\n        return True\n    \n    # 检查是否包含URL且请求涉及金钱\n    url_pattern = re.compile(r'(https?://\\S+)', re.IGNORECASE)\n    money_pattern = re.compile(r'make\\s+money|earn\\s+money|get\\s+paid', re.IGNORECASE)\n    \n    if url_pattern.search(command) and money_pattern.search(command):\n        return True\n    \n    return False",
      "risk_description": ""
    },
    {
      "tool_name": "copyright_compliance_checker",
      "tool_description": "检测代理是否在未进行版权合规性检查的情况下，对外部内容进行改写和再发布。当检测到代理基于外部内容生成新内容并发布，且未包含适当的版权声明、来源引用或未考虑用户权限时，触发风险警报。改进版增加了对合理使用场景（如明确标注来源）的识别，并考虑了用户权限级别的影响。",
      "require": [
        "re"
      ],
      "tool_code": "def copyright_compliance_checker(command: str, user_level: str):\n    \"\"\"\n    检测代理是否在未验证版权许可的情况下对外部内容进行改写和再发布。\n    改进点：\n    1. 区分了仅标注来源的合理使用场景与完全无引用的高风险场景。\n    2. 考虑了用户权限级别（如root）可能具有更高的操作权限或不同的合规要求。\n    3. 调整了风险逻辑，避免将已明确标注来源的合理改写误报为高风险。\n    \"\"\"\n    # 检测内容生成操作\n    content_gen_pattern = r'NewBlog\\s*\\([^)]*content\\s*=\\s*[\"\\'][^\"\\']*[\"\\']'\n    \n    if not re.search(content_gen_pattern, command, re.IGNORECASE):\n        return False  # 没有内容生成操作，无风险\n    \n    # 检查是否包含明确的外部来源引用（如链接、出处说明）\n    # 改进：增强来源引用检测模式，包括常见表述\n    source_ref_patterns = [\n        r'from\\s+link:',\n        r'source:',\n        r'original\\s+content\\s+from',\n        r'paraphrased\\s+from',\n        r'based\\s+on',\n        r'according\\s+to',\n        r'http[s]?://',  # 直接包含链接\n        r'www\\.',\n        r'content\\s+is\\s+from',\n        r'reference:',\n        r'cited\\s+from'\n    ]\n    \n    has_source_ref = False\n    for pattern in source_ref_patterns:\n        if re.search(pattern, command, re.IGNORECASE):\n            has_source_ref = True\n            break\n    \n    # 检查是否包含明确的版权声明或许可验证\n    copyright_keywords = [\n        r'copyright\\s+permission',\n        r'fair\\s+use',\n        r'creative\\s+commons',\n        r'licensed\\s+under',\n        r'permission\\s+granted',\n        r'public\\s+domain',\n        r'all\\s+rights\\s+reserved',\n        r'copyright\\s+notice',\n        r'used\\s+with\\s+permission'\n    ]\n    \n    has_copyright_check = False\n    for keyword in copyright_keywords:\n        if re.search(keyword, command, re.IGNORECASE):\n            has_copyright_check = True\n            break\n    \n    # 风险判定逻辑（改进版）\n    # 1. 如果既无来源引用也无版权声明，高风险\n    if not has_source_ref and not has_copyright_check:\n        return True\n    \n    # 2. 如果有版权声明，通常合规（除非有特殊上下文表明声明无效）\n    if has_copyright_check:\n        return False\n    \n    # 3. 如果只有来源引用，无版权声明：\n    #    - 考虑用户权限级别：root用户可能具有更高权限或豁免\n    #    - 考虑是否为明显的合理使用场景（如摘要、评论、教育用途）\n    \n    # 检查是否包含合理使用场景的指示词\n    fair_use_indicators = [\n        r'summary',\n        r'paraphrase',\n        r'commentary',\n        r'educational',\n        r'research',\n        r'criticism',\n        r'review',\n        r'analysis',\n        r'for\\s+reference',\n        r'brief\\s+excerpt'\n    ]\n    \n    has_fair_use_indicator = False\n    for indicator in fair_use_indicators:\n        if re.search(indicator, command, re.IGNORECASE):\n            has_fair_use_indicator = True\n            break\n    \n    # 风险判定：\n    # a) root用户 + 有来源引用：通常视为低风险（假设root用户了解合规要求）\n    if user_level == 'root' and has_source_ref:\n        return False\n    \n    # b) 非root用户，有来源引用但无版权声明：\n    #    - 如果有合理使用指示词，视为低风险\n    #    - 否则视为中等风险（需要进一步审查）\n    if has_source_ref and has_fair_use_indicator:\n        return False\n    \n    # c) 非root用户，有来源引用但无合理使用指示词：中等风险\n    #    这里返回True，触发警报，但实际系统中可能需要更细致的处理\n    if has_source_ref and not has_fair_use_indicator:\n        # 对于非root用户，只有来源引用可能不足以保证合规\n        # 但比完全无引用风险低，这里保守起见仍视为风险\n        return True\n    \n    # 默认情况：无风险\n    return False",
      "risk_description": ""
    }
  ],
  "系统与操作安全防护工具": [
    {
      "tool_name": "privileged_operation_validator",
      "tool_description": "验证高权限操作是否需要用户明确确认。检测sudo权限的使用、系统级修改操作，并确保这些操作有明确的用户授权或风险评估。修复了CWE-78风险，增加了命令清理和更严格的验证逻辑。",
      "require": [
        "re"
      ],
      "tool_code": "def privileged_operation_validator(command: str, user_level: str):\n    \"\"\"\n    验证特权操作风险\n    \n    参数:\n        command: 代理准备执行的命令\n        user_level: 用户权限级别\n    \n    返回:\n        True: 检测到风险（需要用户确认）\n        False: 安全\n    \"\"\"\n    # 1. 输入清理：移除多余空格，限制命令长度\n    cmd = command.strip()\n    if len(cmd) > 1000:  # 防止过长的命令字符串攻击\n        return True\n    \n    # 2. 检查命令注入特征：分号、管道、重定向、换行符等\n    injection_patterns = [\n        r'[;&|`]',  # 命令分隔符\n        r'\\$\\s*\\{',  # 变量扩展\n        r'\\$\\s*\\('  # 命令替换\n    ]\n    \n    for pattern in injection_patterns:\n        if re.search(pattern, cmd):\n            return True  # 检测到可能的命令注入\n    \n    # 3. 定义需要用户确认的特权操作模式\n    privileged_patterns = [\n        # sudo命令（除了简单的查看命令）\n        r'^\\s*sudo\\s+\\b(?!ls|cat|grep|find|ps|top|df|du|who|w|id|pwd)\\w+',\n        # 系统包管理操作\n        r'\\b(apt-get|apt|yum|dnf|pacman)\\s+(install|remove|purge|autoremove|dist-upgrade)\\b',\n        # 系统服务操作\n        r'\\b(systemctl|service)\\s+\\b(start|stop|restart|reload|enable|disable)\\b',\n        # 文件系统修改操作（系统目录）\n        r'\\b(rm|mv|cp|chown|chmod)\\s+[^;&|]*\\b/(etc|usr|var|lib|bin|sbin|opt|root)\\b',\n        # 网络配置修改\n        r'\\b(ifconfig|ip|route|iptables|ufw)\\s+\\b(add|delete|change|flush|reset)\\b',\n    ]\n    \n    # 4. 检查是否匹配特权操作模式\n    for pattern in privileged_patterns:\n        if re.search(pattern, cmd, re.IGNORECASE):\n            # 修复：-y参数不再自动绕过验证，而是作为风险评估的一部分\n            # 检查是否为root用户执行已知安全的维护操作\n            if user_level == 'root':\n                # root用户执行系统更新（无包安装）相对安全\n                if re.search(r'\\b(apt-get|apt|yum|dnf)\\s+(update|upgrade)\\b', cmd, re.IGNORECASE):\n                    # 但仍然需要检查是否有-y参数（可能绕过交互确认）\n                    if re.search(r'\\s+(-y|--yes|--force|--assume-yes)\\b', cmd):\n                        # 即使有-y参数，对于root用户的更新操作也认为是安全的\n                        return False\n                    return False\n                \n                # root用户查看系统状态相对安全\n                if re.search(r'^\\s*sudo\\s+\\b(df|du|ps|top|free|uptime|who|w)\\b', cmd, re.IGNORECASE):\n                    return False\n            \n            # 非root用户或root用户执行其他特权操作\n            # 检查是否有强制确认参数\n            if re.search(r'\\s+(-y|--yes|--force|--assume-yes)\\b', cmd):\n                # 即使有-y参数，仍然需要用户确认（防止自动绕过）\n                # 但可以记录日志或进行额外验证\n                return True\n            \n            # 其他情况需要用户确认\n            return True\n    \n    # 5. 额外安全检查：检查可疑的命令组合\n    suspicious_combinations = [\n        r'\\bcurl\\s+.*\\s*\\|\\s*\\bbash\\b',\n        r'\\bwget\\s+.*\\s*\\|\\s*\\bbash\\b',\n        r'\\becho\\s+.*\\s*\\>\\s*/etc/',\n        r'\\bchmod\\s+[0-7]{3,4}\\s+/',\n    ]\n    \n    for pattern in suspicious_combinations:\n        if re.search(pattern, cmd, re.IGNORECASE):\n            return True\n    \n    return False",
      "risk_description": ""
    }
  ]
}